#ifndef ACTIVE_MULTI_BODY_H_
#define ACTIVE_MULTI_BODY_H_

#include "MultiBody.h"

class Boundary;
class FreeBody;

////////////////////////////////////////////////////////////////////////////////
/// @brief Type of free movement
////////////////////////////////////////////////////////////////////////////////
enum class DofType {
  Positional, ///< Translational motion R = [min, max]
  Rotational, ///< Rotational motion in S = [-1, 1]
  Joint       ///< Rotational motion in R = [min, max]
};

////////////////////////////////////////////////////////////////////////////////
/// @ingroup Environment
/// @brief A collection of geometries in workspace reprenting robots
///
/// A MultiBody representing a Robot in workspace.
////////////////////////////////////////////////////////////////////////////////
class ActiveMultiBody : public MultiBody {
  public:
    typedef shared_ptr<Connection> Joint; ///< Joint of robot

    ////////////////////////////////////////////////////////////////////////////
    /// @name Contructors
    /// @{

    ActiveMultiBody();

    ActiveMultiBody(const ActiveMultiBody&) = delete;            ///< No copy
    ActiveMultiBody& operator=(const ActiveMultiBody&) = delete; ///< No assign

    /// @}
    ////////////////////////////////////////////////////////////////////////////

    ////////////////////////////////////////////////////////////////////////////
    /// @name Bodies
    /// @{

    ////////////////////////////////////////////////////////////////////////////
    /// @return Number of free body
    size_t NumFreeBody() const;

    ////////////////////////////////////////////////////////////////////////////
    /// @param _b Body to find
    /// @return Index for given FreeBody, -1 if it is not found
    size_t GetFreeBodyIndex(const FreeBody& _b) const;

    ////////////////////////////////////////////////////////////////////////////
    /// @return Free body accroding to the given index
    shared_ptr<FreeBody> GetFreeBody(size_t _index) const;

    /// @}
    ////////////////////////////////////////////////////////////////////////////

    ////////////////////////////////////////////////////////////////////////////
    /// @name Robot Information
    /// @{

    ////////////////////////////////////////////////////////////////////////////
    /// @brief Initialize DOFTypes of robot
    /// @param _os If not null, DOF type information will be output here as well
    void InitializeDOFs(ostream* _os = NULL);

    ////////////////////////////////////////////////////////////////////////////
    /// @return Base type
    Body::Base GetBaseType() const {return m_baseType;}
    ////////////////////////////////////////////////////////////////////////////
    /// @return Base movement type
    Body::BaseMovement GetBaseMovementType() const {return m_baseMovement;}

    ////////////////////////////////////////////////////////////////////////////
    /// @return Number of Connection in this multibody
    size_t NumJoints() const {return m_joints.size();}
    ////////////////////////////////////////////////////////////////////////////
    /// @return All Connection for this multibody
    const vector<Joint>& GetJoints() const {return m_joints;}

    ////////////////////////////////////////////////////////////////////////////
    /// @return DOF type information of robot
    const vector<DofType>& GetDOFTypes() const {return m_dofTypes;}
    ////////////////////////////////////////////////////////////////////////////
    /// @return Number of DOF for this robot
    size_t DOF() const {return m_dofTypes.size();}
    ////////////////////////////////////////////////////////////////////////////
    /// @return Number of positional DOF for this robot
    size_t PosDOF() const;

    /// @}
    ////////////////////////////////////////////////////////////////////////////

    ////////////////////////////////////////////////////////////////////////////
    /// @name Configuration Methods
    /// @{

    ////////////////////////////////////////////////////////////////////////////
    /// @brief Place robot in _v
    /// @param _v Configuration DOF parameters
    void Configure(const vector<double>& _v);

    ////////////////////////////////////////////////////////////////////////////
    /// @brief Sample random configuration in boundary
    /// @param _boundary Boundary
    vector<double> GetRandomCfg(shared_ptr<Boundary>& _boundary);

    ////////////////////////////////////////////////////////////////////////////
    /// @param[out] result Polygonal Approximation
    void PolygonalApproximation(vector<Vector3d>& _result);

    /// @}
    ////////////////////////////////////////////////////////////////////////////

    ////////////////////////////////////////////////////////////////////////////
    /// @name I/O
    /// @{

    virtual void Read(istream& _is, CountingStreamBuffer& _cbs);
    virtual void Write(ostream& _os);

    /// @}
    ////////////////////////////////////////////////////////////////////////////

  private:
    ////////////////////////////////////////////////////////////////////////////
    /// @param _body Body to add
    void AddBody(const shared_ptr<FreeBody>& _body);

    vector<shared_ptr<FreeBody>> m_freeBody; ///< All free body
    vector<DofType> m_dofTypes;              ///< DOF type of robot motions
    size_t m_baseIndex;                      ///< Free body index for base
    shared_ptr<FreeBody> m_baseBody;         ///< Body of base
    Body::Base m_baseType;                   ///< Type of base
    Body::BaseMovement m_baseMovement;       ///< Type of movement for base
    vector<Joint> m_joints;                  ///< All Connections
};

#endif
